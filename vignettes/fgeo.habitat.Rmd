---
title: "Get started"
author: "Mauro Lepore"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Get started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
set.seed(1014)
knitr::opts_chunk$set(
  echo = TRUE,
  comment = "#>",
  collapse = TRUE,
  cache = FALSE,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.asp = 0.618,
  fig.show = "hold"
)
```

```{r}
library(fgeo.habitat)
library(tidyverse)
```

## Habitat-species associations

Torus translation test to determine habitat associations of tree species: `tt_test()`, by Sabrina Russo, Daniel Zuleta, Matteo Detto, and Kyle Harms.

```{r}
# Example data
habitat <- luquillo_habitat
census <- luquillo_top3_sp

# Pick alive trees, of 10 mm or more
pick <- filter(census, status == "A", dbh >= 10)
# Pick sufficiently abundant trees
pick <- add_count(pick, sp)
pick <- filter(pick, n > 50)

species <- unique(pick$sp)

out <- tt_test(species, census, habitat)
# Try also: View(out)
head(out)
tail(out)
```

## Krige soil data

Krige soil data with `krig()`, by Graham Zemunik.

### Compare parameters

```{r}
# Example data
soil <- soil_random
str(soil)
```

Krige with automated parameters.

```{r}
auto <- krig(soil, var = "m3al")
```

```{r}
summary(auto)
```

Try also:

```R
View(auto)
```

<img src="https://i.imgur.com/fTDjckj.png" align="center" height=150 />

```{r}
str(auto$df, give.attr = FALSE)
```

With custom params (arbitrary but based on automated kriging params).

```{r}
params <- list(
  model = "circular", range = 100, nugget = 1000, sill = 46000, kappa = 0.5
)
# Quietly
custom <- suppressMessages(
  krig(soil, var = "m3al", params = params)
)
```

```{r}
str(custom$df, give.attr = FALSE)
```

Compare.

```{r, fig.align="default", out.width="45%", fig.widh=(6 * 0.5 / 0.7)}
title_auto <- "Automated parameters"
ggplot(auto$df, aes(x = x, y = y, fill = z)) +
  geom_tile() + 
  coord_equal() +
  labs(title = title_auto)

title_custom <- "Custom parameters"
ggplot(custom$df, aes(x = x, y = y, fill = z)) +
  geom_tile() + 
  coord_equal() +
  labs(title = title_custom)
```

### Iterate over multiple soil variables

```{r}
soil <- soil_fake
soil
```

Scale soil data to make their values fall within the same range. In the following section, this will ease visual comparison.

```{r}
soil_vars <- c("mg", "c", "p")
soil_fake[soil_vars] <- map_df(soil_fake[soil_vars], scale)
soil_fake
```

Iterate. Create a function `krig_df()` to run `krig()` quietly and pull the `df` element of the resulting list.

```{r}
krig_df <- function(var) {
  out <- suppressMessages(krig(soil_fake, var))
  out$df
}
```

Iterate: Apply `krig_df()` for each soil variable.

```{r}
dfs <- map(soil_vars, krig_df)
dfs <-   set_names(dfs, soil_vars)
map(dfs, head)
```

### Visualize multiple soil variables

Re structure as a long-format dataframe to allow facetting with __gglot2__.

```{r}
dfs2 <- unnest(enframe(dfs, name = "soil_var"))
dfs2
```

Visualize.

```{r out.width="90%"}
ggplot(dfs2, aes(x, y, fill = z)) +
  geom_tile() +
  facet_wrap("soil_var") +
  coord_equal()
```

